name: ie-bank-frontend
on:
 push:
   paths:
     - 'frontend/**'
   branches: ['*']
 pull_request:
   branches: [main]
   paths: ['frontend/**']
 workflow_dispatch:

env:
 IMAGE_NAME: ie-bank-frontend
 FRONTEND_WEBAPP_DEV: dkumlin-fe-dev
 FRONTEND_WEBAPP_UAT: dkumlin-fe-uat

jobs:
 build:
   runs-on: ubuntu-latest
   outputs:
     image-version: ${{ steps.image-version.outputs.version }}
   environment: Development
   steps:
     - uses: actions/checkout@v3
     
     - name: Set image version
       id: image-version
       run: echo "version=$(date +'%Y.%m.%d.%H.%M')" >> $GITHUB_OUTPUT

     - name: Debug - Print Variables
       run: |
         echo "NODE_ENV: ${{ vars.NODE_ENV }}"
         echo "VUE_APP_ROOT_API: ${{ vars.VUE_APP_ROOT_API }}"
         echo "BASE_URL: ${{ vars.BASE_URL }}"
     
     - name: Azure login
       uses: azure/login@v2
       with:
         creds: ${{ secrets.AZURE_CREDENTIALS }}

     - name: Docker login
       uses: docker/login-action@v1
       with:
         registry: ${{ vars.DOCKER_REGISTRY_SERVER_URL }}
         username: ${{ secrets.REGISTRY_USERNAME }}
         password: ${{ secrets.REGISTRY_PASSWORD }}
      
     - name: Build and push image
       env:
         NODE_ENV: ${{ vars.NODE_ENV }}
         VUE_APP_ROOT_API: ${{ vars.VUE_APP_ROOT_API }}
         BASE_URL: ${{ vars.BASE_URL }}
       run: |
         docker build ./frontend \
           --build-arg NODE_ENV=$NODE_ENV \
           --build-arg VUE_APP_ROOT_API=$VUE_APP_ROOT_API \
           --build-arg BASE_URL=$BASE_URL \
           -t ${{ vars.DOCKER_REGISTRY_SERVER_URL }}/${{ env.IMAGE_NAME }}:${{ steps.image-version.outputs.version }} \
           -t ${{ vars.DOCKER_REGISTRY_SERVER_URL }}/${{ env.IMAGE_NAME }}:latest
         docker push ${{ vars.DOCKER_REGISTRY_SERVER_URL }}/${{ env.IMAGE_NAME }}:${{ steps.image-version.outputs.version }}
         docker push ${{ vars.DOCKER_REGISTRY_SERVER_URL }}/${{ env.IMAGE_NAME }}:latest

 deploy-dev:
   needs: build
   runs-on: ubuntu-latest
   environment:
     name: Development
     url: ${{ steps.deploy-to-webapp.outputs.webapp-url }}
   steps:
     - uses: azure/login@v2
       with:
         creds: ${{ secrets.AZURE_CREDENTIALS }}
    
     - name: Deploy to Azure Web App
       id: deploy-to-webapp
       uses: azure/webapps-deploy@v3
       with:
         app-name: ${{ env.FRONTEND_WEBAPP_DEV }}
         images: '${{ vars.DOCKER_REGISTRY_SERVER_URL }}/${{ env.IMAGE_NAME }}:${{ needs.build.outputs.image-version }}'

 deploy-uat:
   if: github.event_name == 'pull_request' && github.base_ref == 'main'
   needs: build
   runs-on: ubuntu-latest
   environment:
     name: UAT
     url: ${{ steps.deploy-to-webapp.outputs.webapp-url }}
   steps:
     - uses: azure/login@v2
       with:
         creds: ${{ secrets.AZURE_CREDENTIALS }}
        
     - name: Deploy to Azure Web App (UAT)
       id: deploy-to-webapp
       uses: azure/webapps-deploy@v3
       with:
         app-name: ${{ env.FRONTEND_WEBAPP_UAT }}
         images: '${{ vars.DOCKER_REGISTRY_SERVER_URL }}/${{ env.IMAGE_NAME }}:${{ needs.build.outputs.image-version }}'
